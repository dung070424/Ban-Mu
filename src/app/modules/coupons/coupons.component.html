<div class="coupons-container">
  <!-- Header -->
  <div class="coupons-header">
    <div class="header-left">
      <h1>Qu·∫£n l√Ω phi·∫øu gi·∫£m gi√°</h1>
      <p>T·∫°o v√† qu·∫£n l√Ω c√°c m√£ gi·∫£m gi√° cho kh√°ch h√†ng</p>
    </div>
    <div class="header-right">
      <button class="add-coupon-btn" (click)="openAddModal()">
        <span>+</span>
        T·∫°o phi·∫øu gi·∫£m gi√°
      </button>
    </div>
  </div>

  <!-- Statistics -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon">üé´</div>
      <div class="stat-content">
        <div class="stat-value">{{ totalCoupons() }}</div>
        <div class="stat-label">T·ªïng phi·∫øu gi·∫£m gi√°</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-content">
        <div class="stat-value">{{ activeCoupons() }}</div>
        <div class="stat-label">ƒêang ho·∫°t ƒë·ªông</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">‚è∞</div>
      <div class="stat-content">
        <div class="stat-value">{{ expiredCoupons() }}</div>
        <div class="stat-label">ƒê√£ h·∫øt h·∫°n</div>
      </div>
    </div>
    <div class="stat-card">
      <div class="stat-icon">üìä</div>
      <div class="stat-content">
        <div class="stat-value">{{ totalUsage() }}</div>
        <div class="stat-label">L·∫ßn s·ª≠ d·ª•ng</div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters-section">
    <div class="search-box">
      <input
        type="text"
        placeholder="T√¨m ki·∫øm phi·∫øu gi·∫£m gi√°..."
        [value]="searchTerm()"
        (input)="onSearchInput($event)"
      />
      <span class="search-icon">üîç</span>
    </div>
    <select [value]="selectedStatus()" (change)="onStatusChange($event)" class="filter-select">
      <option value="all">T·∫•t c·∫£ tr·∫°ng th√°i</option>
      <option value="active">ƒêang ho·∫°t ƒë·ªông</option>
      <option value="inactive">T·∫°m d·ª´ng</option>
      <option value="expired">H·∫øt h·∫°n</option>
    </select>
    <select [value]="selectedType()" (change)="onTypeChange($event)" class="filter-select">
      <option value="all">T·∫•t c·∫£ lo·∫°i</option>
      <option value="percentage">Ph·∫ßn trƒÉm</option>
      <option value="fixed">C·ªë ƒë·ªãnh</option>
    </select>
  </div>

  <!-- Coupons Grid -->
  <div class="coupons-grid">
    @for (coupon of filteredCoupons(); track coupon.id) {
    <div class="coupon-card" [class]="'status-' + getCouponStatus(coupon)">
      <div class="coupon-header">
        <div class="coupon-code">{{ coupon.code }}</div>
        <div class="coupon-status" [class]="'status-' + getCouponStatus(coupon)">
          @if (getCouponStatus(coupon) === 'active') { ƒêang ho·∫°t ƒë·ªông } @else if
          (getCouponStatus(coupon) === 'expired') { H·∫øt h·∫°n } @else if (getCouponStatus(coupon) ===
          'upcoming') { S·∫Øp di·ªÖn ra } @else { T·∫°m d·ª´ng }
        </div>
      </div>

      <div class="coupon-info">
        <h3 class="coupon-name">{{ coupon.name }}</h3>
        <p class="coupon-description">{{ coupon.description }}</p>

        <div class="coupon-details">
          <div class="detail-row">
            <span class="detail-label">Lo·∫°i gi·∫£m gi√°:</span>
            <span class="detail-value">
              @if (coupon.type === 'percentage') {
              {{ coupon.value }}% @if (coupon.maxDiscountAmount) { (t·ªëi ƒëa
              {{ formatVnd(coupon.maxDiscountAmount) }}) } } @else {
              {{ formatVnd(coupon.value) }}
              }
            </span>
          </div>
          <div class="detail-row">
            <span class="detail-label">ƒê∆°n h√†ng t·ªëi thi·ªÉu:</span>
            <span class="detail-value">{{ formatVnd(coupon.minOrderAmount) }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">S·ª≠ d·ª•ng:</span>
            <span class="detail-value">{{ coupon.usedCount }}/{{ coupon.usageLimit }}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Th·ªùi gian:</span>
            <span class="detail-value">
              {{ formatDate(coupon.startDate) }} - {{ formatDate(coupon.endDate) }}
            </span>
          </div>
          @if (getCouponStatus(coupon) === 'active' && !isCouponExpired(coupon)) {
          <div class="detail-row">
            <span class="detail-label">C√≤n l·∫°i:</span>
            <span class="detail-value">{{ getRemainingDays(coupon) }} ng√†y</span>
          </div>
          }
        </div>

        <div class="usage-bar">
          <div class="usage-progress" [style.width.%]="getUsagePercentage(coupon)"></div>
        </div>
      </div>

      <div class="coupon-actions">
        <button class="action-btn view-btn" (click)="openDetailModal(coupon)">üëÅÔ∏è</button>
        <button class="action-btn edit-btn" (click)="openEditModal(coupon)">‚úèÔ∏è</button>
        <button
          class="action-btn status-btn"
          [class]="'status-' + coupon.status"
          (click)="toggleCouponStatus(coupon)"
          [disabled]="isCouponExpired(coupon)"
        >
          {{ coupon.status === 'active' ? '‚è∏Ô∏è' : '‚ñ∂Ô∏è' }}
        </button>
        <button class="action-btn delete-btn" (click)="deleteCoupon(coupon.id)">üóëÔ∏è</button>
      </div>
    </div>
    }
  </div>

  <!-- Add Coupon Modal -->
  @if (showAddModal()) {
  <div class="modal-overlay" (click)="closeModals()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>T·∫°o phi·∫øu gi·∫£m gi√° m·ªõi</h3>
        <button class="close-btn" (click)="closeModals()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>M√£ phi·∫øu gi·∫£m gi√° *</label>
            <div class="input-with-button">
              <input type="text" [(ngModel)]="newCoupon().code" placeholder="WELCOME10" />
              <button
                type="button"
                class="generate-btn"
                (click)="newCoupon().code = generateCouponCode()"
              >
                T·∫°o t·ª± ƒë·ªông
              </button>
            </div>
          </div>
          <div class="form-group">
            <label>T√™n phi·∫øu gi·∫£m gi√° *</label>
            <input
              type="text"
              [(ngModel)]="newCoupon().name"
              placeholder="Ch√†o m·ª´ng kh√°ch h√†ng m·ªõi"
            />
          </div>
        </div>

        <div class="form-group">
          <label>M√¥ t·∫£</label>
          <textarea
            [(ngModel)]="newCoupon().description"
            placeholder="M√¥ t·∫£ v·ªÅ phi·∫øu gi·∫£m gi√°"
            rows="3"
          ></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Lo·∫°i gi·∫£m gi√° *</label>
            <select [(ngModel)]="newCoupon().type">
              <option value="percentage">Ph·∫ßn trƒÉm (%)</option>
              <option value="fixed">S·ªë ti·ªÅn c·ªë ƒë·ªãnh (VNƒê)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Gi√° tr·ªã gi·∫£m gi√° *</label>
            <input type="number" [(ngModel)]="newCoupon().value" placeholder="10" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ƒê∆°n h√†ng t·ªëi thi·ªÉu (VNƒê)</label>
            <input type="number" [(ngModel)]="newCoupon().minOrderAmount" placeholder="500000" />
          </div>
          <div class="form-group" *ngIf="newCoupon().type === 'percentage'">
            <label>Gi·∫£m gi√° t·ªëi ƒëa (VNƒê)</label>
            <input type="number" [(ngModel)]="newCoupon().maxDiscountAmount" placeholder="100000" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Gi·ªõi h·∫°n s·ª≠ d·ª•ng</label>
            <input type="number" [(ngModel)]="newCoupon().usageLimit" placeholder="100" />
          </div>
          <div class="form-group">
            <label>Tr·∫°ng th√°i</label>
            <select [(ngModel)]="newCoupon().status">
              <option value="active">Ho·∫°t ƒë·ªông</option>
              <option value="inactive">T·∫°m d·ª´ng</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Ng√†y b·∫Øt ƒë·∫ßu</label>
            <input
              type="date"
              [value]="formatDateForInput(newCoupon().startDate)"
              (change)="onNewCouponDateChange('startDate', $event)"
            />
          </div>
          <div class="form-group">
            <label>Ng√†y k·∫øt th√∫c</label>
            <input
              type="date"
              [value]="formatDateForInput(newCoupon().endDate)"
              (change)="onNewCouponDateChange('endDate', $event)"
            />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeModals()">H·ªßy</button>
        <button class="save-btn" (click)="addCoupon()">T·∫°o phi·∫øu gi·∫£m gi√°</button>
      </div>
    </div>
  </div>
  }

  <!-- Edit Coupon Modal -->
  @if (showEditModal() && selectedCoupon()) {
  <div class="modal-overlay" (click)="closeModals()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Ch·ªânh s·ª≠a phi·∫øu gi·∫£m gi√°</h3>
        <button class="close-btn" (click)="closeModals()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-row">
          <div class="form-group">
            <label>M√£ phi·∫øu gi·∫£m gi√° *</label>
            <input
              type="text"
              [value]="selectedCoupon()?.code"
              (input)="onCouponFieldChange('code', $event)"
            />
          </div>
          <div class="form-group">
            <label>T√™n phi·∫øu gi·∫£m gi√° *</label>
            <input
              type="text"
              [value]="selectedCoupon()?.name"
              (input)="onCouponFieldChange('name', $event)"
            />
          </div>
        </div>

        <div class="form-group">
          <label>M√¥ t·∫£</label>
          <textarea
            [value]="selectedCoupon()?.description"
            (input)="onCouponFieldChange('description', $event)"
            rows="3"
          ></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Lo·∫°i gi·∫£m gi√° *</label>
            <select [value]="selectedCoupon()?.type" (change)="onCouponTypeChange($event)">
              <option value="percentage">Ph·∫ßn trƒÉm (%)</option>
              <option value="fixed">S·ªë ti·ªÅn c·ªë ƒë·ªãnh (VNƒê)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Gi√° tr·ªã gi·∫£m gi√° *</label>
            <input
              type="number"
              [value]="selectedCoupon()?.value"
              (input)="onCouponNumberFieldChange('value', $event)"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>ƒê∆°n h√†ng t·ªëi thi·ªÉu (VNƒê)</label>
            <input
              type="number"
              [value]="selectedCoupon()?.minOrderAmount"
              (input)="onCouponNumberFieldChange('minOrderAmount', $event)"
            />
          </div>
          <div class="form-group" *ngIf="selectedCoupon()?.type === 'percentage'">
            <label>Gi·∫£m gi√° t·ªëi ƒëa (VNƒê)</label>
            <input
              type="number"
              [value]="selectedCoupon()?.maxDiscountAmount"
              (input)="onCouponNumberFieldChange('maxDiscountAmount', $event)"
            />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Gi·ªõi h·∫°n s·ª≠ d·ª•ng</label>
            <input
              type="number"
              [value]="selectedCoupon()?.usageLimit"
              (input)="onCouponNumberFieldChange('usageLimit', $event)"
            />
          </div>
          <div class="form-group">
            <label>Tr·∫°ng th√°i</label>
            <select [value]="selectedCoupon()?.status" (change)="onCouponStatusChange($event)">
              <option value="active">Ho·∫°t ƒë·ªông</option>
              <option value="inactive">T·∫°m d·ª´ng</option>
              <option value="expired">H·∫øt h·∫°n</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Ng√†y b·∫Øt ƒë·∫ßu</label>
            <input
              type="date"
              [value]="formatDateForInput(selectedCoupon()?.startDate)"
              (change)="onCouponDateChange('startDate', $event)"
            />
          </div>
          <div class="form-group">
            <label>Ng√†y k·∫øt th√∫c</label>
            <input
              type="date"
              [value]="formatDateForInput(selectedCoupon()?.endDate)"
              (change)="onCouponDateChange('endDate', $event)"
            />
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeModals()">H·ªßy</button>
        <button class="save-btn" (click)="updateCoupon()">C·∫≠p nh·∫≠t</button>
      </div>
    </div>
  </div>
  }

  <!-- Coupon Detail Modal -->
  @if (showDetailModal() && selectedCoupon()) {
  <div class="modal-overlay" (click)="closeModals()">
    <div class="modal-content detail-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Chi ti·∫øt phi·∫øu gi·∫£m gi√°</h3>
        <button class="close-btn" (click)="closeModals()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="coupon-detail-header">
          <div class="coupon-code-large">{{ selectedCoupon()?.code }}</div>
          <div class="coupon-status-large" [class]="'status-' + getCouponStatus(selectedCoupon()!)">
            @if (getCouponStatus(selectedCoupon()!) === 'active') { ƒêang ho·∫°t ƒë·ªông } @else if
            (getCouponStatus(selectedCoupon()!) === 'expired') { H·∫øt h·∫°n } @else if
            (getCouponStatus(selectedCoupon()!) === 'upcoming') { S·∫Øp di·ªÖn ra } @else { T·∫°m d·ª´ng }
          </div>
        </div>

        <div class="detail-sections">
          <div class="detail-section">
            <h4>Th√¥ng tin c∆° b·∫£n</h4>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">T√™n:</span>
                <span class="detail-value">{{ selectedCoupon()?.name }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">M√¥ t·∫£:</span>
                <span class="detail-value">{{ selectedCoupon()?.description }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Lo·∫°i gi·∫£m gi√°:</span>
                <span class="detail-value">
                  @if (selectedCoupon()?.type === 'percentage') {
                  {{ selectedCoupon()?.value }}% @if (selectedCoupon()?.maxDiscountAmount) { (t·ªëi ƒëa
                  {{ formatVnd(selectedCoupon()?.maxDiscountAmount || 0) }}) } } @else {
                  {{ formatVnd(selectedCoupon()?.value || 0) }}
                  }
                </span>
              </div>
              <div class="detail-item">
                <span class="detail-label">ƒê∆°n h√†ng t·ªëi thi·ªÉu:</span>
                <span class="detail-value">{{
                  formatVnd(selectedCoupon()?.minOrderAmount || 0)
                }}</span>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h4>Th√¥ng tin s·ª≠ d·ª•ng</h4>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">ƒê√£ s·ª≠ d·ª•ng:</span>
                <span class="detail-value"
                  >{{ selectedCoupon()?.usedCount }}/{{ selectedCoupon()?.usageLimit }}</span
                >
              </div>
              <div class="detail-item">
                <span class="detail-label">T·ª∑ l·ªá s·ª≠ d·ª•ng:</span>
                <span class="detail-value"
                  >{{ getUsagePercentage(selectedCoupon()!) | number : '1.1-1' }}%</span
                >
              </div>
              <div class="detail-item">
                <span class="detail-label">C√≤n l·∫°i:</span>
                <span class="detail-value"
                  >{{
                    (selectedCoupon()?.usageLimit || 0) - (selectedCoupon()?.usedCount || 0)
                  }}
                  l·∫ßn</span
                >
              </div>
            </div>
            <div class="usage-bar-large">
              <div
                class="usage-progress"
                [style.width.%]="getUsagePercentage(selectedCoupon()!)"
              ></div>
            </div>
          </div>

          <div class="detail-section">
            <h4>Th·ªùi gian √°p d·ª•ng</h4>
            <div class="detail-grid">
              <div class="detail-item">
                <span class="detail-label">Ng√†y b·∫Øt ƒë·∫ßu:</span>
                <span class="detail-value">{{
                  formatDateOrCurrent(selectedCoupon()?.startDate)
                }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Ng√†y k·∫øt th√∫c:</span>
                <span class="detail-value">{{
                  formatDateOrCurrent(selectedCoupon()?.endDate)
                }}</span>
              </div>
              @if (getCouponStatus(selectedCoupon()!) === 'active' &&
              !isCouponExpired(selectedCoupon()!)) {
              <div class="detail-item">
                <span class="detail-label">C√≤n l·∫°i:</span>
                <span class="detail-value">{{ getRemainingDays(selectedCoupon()!) }} ng√†y</span>
              </div>
              }
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="cancel-btn" (click)="closeModals()">ƒê√≥ng</button>
        <button class="edit-btn" (click)="openEditModal(selectedCoupon()!)">Ch·ªânh s·ª≠a</button>
      </div>
    </div>
  </div>
  }
</div>
