<div class="pos-container">
  <!-- Header -->
  <div class="pos-header">
    <div class="header-left">
      <h1>B√°n h√†ng</h1>
      <p>Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ th√™m v√†o gi·ªè h√†ng</p>
    </div>
    <div class="header-right">
      <div class="search-box">
        <input
          type="text"
          placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..."
          [value]="searchTerm()"
          (input)="onSearchInput($event)"
        />
        <span class="search-icon">üîç</span>
      </div>
      <select
        [value]="selectedCategory()"
        (change)="onCategoryChange($event)"
        class="category-filter"
      >
        @for (category of categories(); track category.id) {
        <option [value]="category.id">{{ category.name }}</option>
        }
      </select>
    </div>
  </div>

  <div class="pos-content">
    <!-- S·∫£n ph·∫©m -->
    <div class="products-section">
      <div class="products-grid">
        @for (product of filteredProducts(); track product.id) {
        <div class="product-card">
          <div class="product-image">
            <img [src]="product.imageUrl" [alt]="product.name" />
            <div class="product-badge" [class.out-of-stock]="product.stock <= 0">
              {{ product.stock > 0 ? product.stock + ' c√°i' : 'H·∫øt h√†ng' }}
            </div>
          </div>
          <div class="product-info">
            <h3>{{ product.name }}</h3>
            <p class="product-description">{{ product.description }}</p>
            <div class="product-category">{{ product.category }}</div>
            <div class="product-footer">
              <div class="product-price">{{ formatVnd(product.price) }}</div>
              <button
                class="add-to-cart-btn"
                (click)="addToCart(product.id)"
                [disabled]="product.stock <= 0"
              >
                {{ product.stock > 0 ? '+ Th√™m' : 'H·∫øt h√†ng' }}
              </button>
            </div>
          </div>
        </div>
        }
      </div>
    </div>

    <!-- Gi·ªè h√†ng -->
    <div class="cart-section">
      <div class="cart-header">
        <h3>Gi·ªè h√†ng</h3>
        <div class="cart-summary">
          <span>{{ cartTotalQuantity() }} m√≥n</span>
          <span class="cart-total">{{ formatVnd(cartTotalPrice()) }}</span>
        </div>
      </div>

      <!-- Ch·ªçn kh√°ch h√†ng -->
      <div class="customer-selection">
        @if (selectedCustomer()) {
        <div class="selected-customer">
          <div class="customer-info">
            <div class="customer-name">{{ selectedCustomer()!.name }}</div>
            <div class="customer-phone">{{ selectedCustomer()!.phone }}</div>
          </div>
          <button class="clear-customer-btn" (click)="clearSelectedCustomer()">√ó</button>
        </div>
        } @else {
        <button class="select-customer-btn" (click)="openCustomerModal()">
          <span class="btn-icon">üë§</span>
          Ch·ªçn kh√°ch h√†ng
        </button>
        }
      </div>

      <div class="cart-content">
        @if (cartItems().length === 0) {
        <div class="cart-empty">
          <div class="empty-icon">üõí</div>
          <p>Gi·ªè h√†ng tr·ªëng</p>
          <small>Ch·ªçn s·∫£n ph·∫©m ƒë·ªÉ th√™m v√†o gi·ªè</small>
        </div>
        } @else {
        <div class="cart-items">
          @for (item of cartItems(); track item.id) {
          <div class="cart-item">
            <div class="item-info">
              <h4>{{ item.name }}</h4>
              <p>{{ formatVnd(item.price) }}</p>
            </div>
            <div class="item-controls">
              <button (click)="decreaseQty(item.id)" class="qty-btn">-</button>
              <span class="qty">{{ item.qty }}</span>
              <button (click)="increaseQty(item.id)" class="qty-btn">+</button>
              <button (click)="removeFromCart(item.id)" class="remove-btn">√ó</button>
            </div>
            <div class="item-total">{{ formatVnd(item.price * item.qty) }}</div>
          </div>
          }
        </div>
        }
      </div>

      @if (cartItems().length > 0) {
      <div class="cart-footer">
        <button class="clear-cart-btn" (click)="clearCart()">X√≥a t·∫•t c·∫£</button>
        <button class="checkout-btn" (click)="processPayment()">
          Thanh to√°n {{ formatVnd(finalTotal()) }}
        </button>
      </div>
      }
    </div>
  </div>
</div>

<!-- Modal thanh to√°n -->
@if (showPaymentModal()) {
<div class="modal-overlay" (click)="closePaymentModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Thanh to√°n</h2>
      <button class="close-btn" (click)="closePaymentModal()">√ó</button>
    </div>

    <div class="modal-body">
      <!-- Th√¥ng tin ƒë∆°n h√†ng -->
      <div class="order-summary">
        <h3>Th√¥ng tin ƒë∆°n h√†ng</h3>
        <div class="summary-items">
          @for (item of cartItems(); track item.id) {
          <div class="summary-item">
            <span>{{ item.name }} x{{ item.qty }}</span>
            <span>{{ formatVnd(item.price * item.qty) }}</span>
          </div>
          }
        </div>
        <div class="summary-total">
          <span>T·ªïng c·ªông:</span>
          <span>{{ formatVnd(cartTotalPrice()) }}</span>
        </div>

        <!-- M√£ gi·∫£m gi√° -->
        <div class="coupon-section">
          <h4>Phi·∫øu gi·∫£m gi√°</h4>
          @if (!appliedCoupon()) {
          <div class="coupon-input">
            <input
              type="text"
              placeholder="Nh·∫≠p m√£ gi·∫£m gi√°..."
              [value]="couponCode()"
              (input)="couponCode.set(($any($event.target).value || '').toUpperCase())"
              (keydown.enter)="applyCoupon()"
            />
            <button (click)="applyCoupon()">√Åp d·ª•ng</button>
          </div>
          } @else {
          <div class="coupon-applied">
            <span
              >ƒêang √°p d·ª•ng: <strong>{{ appliedCoupon()!.code }}</strong></span
            >
            <button class="remove-coupon" (click)="removeCoupon()">H·ªßy</button>
          </div>
          } @if (discountAmount() > 0) {
          <div class="discount-row">
            <span>Gi·∫£m gi√°:</span>
            <span>-{{ formatVnd(discountAmount()) }}</span>
          </div>
          }
          <div class="final-row">
            <span>Thanh to√°n:</span>
            <span>{{ formatVnd(finalTotal()) }}</span>
          </div>
        </div>
      </div>

      <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
      <div class="payment-methods">
        <h3>Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
        <div class="payment-options">
          <label class="payment-option" [class.selected]="selectedPaymentMethod() === 'cash'">
            <input
              type="radio"
              name="payment"
              value="cash"
              [checked]="selectedPaymentMethod() === 'cash'"
              (change)="onPaymentMethodChange($event)"
            />
            <div class="payment-info">
              <span class="payment-icon">üíµ</span>
              <span class="payment-name">Ti·ªÅn m·∫∑t</span>
            </div>
          </label>

          <label class="payment-option" [class.selected]="selectedPaymentMethod() === 'card'">
            <input
              type="radio"
              name="payment"
              value="card"
              [checked]="selectedPaymentMethod() === 'card'"
              (change)="onPaymentMethodChange($event)"
            />
            <div class="payment-info">
              <span class="payment-icon">üí≥</span>
              <span class="payment-name">Th·∫ª</span>
            </div>
          </label>

          <label class="payment-option" [class.selected]="selectedPaymentMethod() === 'transfer'">
            <input
              type="radio"
              name="payment"
              value="transfer"
              [checked]="selectedPaymentMethod() === 'transfer'"
              (change)="onPaymentMethodChange($event)"
            />
            <div class="payment-info">
              <span class="payment-icon">üè¶</span>
              <span class="payment-name">Chuy·ªÉn kho·∫£n</span>
            </div>
          </label>
        </div>
      </div>

      <!-- S·ªë ti·ªÅn kh√°ch ƒë∆∞a (ch·ªâ hi·ªán khi ch·ªçn ti·ªÅn m·∫∑t) -->
      @if (selectedPaymentMethod() === 'cash') {
      <div class="cash-payment">
        <h3>S·ªë ti·ªÅn kh√°ch ƒë∆∞a</h3>
        <div class="amount-input">
          <input
            type="number"
            placeholder="Nh·∫≠p s·ªë ti·ªÅn kh√°ch ƒë∆∞a..."
            [value]="customerAmount()"
            (input)="onCustomerAmountChange($event)"
            class="amount-field"
          />
          <button class="quick-amount-btn" (click)="setExactAmount()">Ch√≠nh x√°c</button>
        </div>

        @if (customerAmount() > 0) {
        <div class="change-info">
          <div class="change-amount">
            <span>Ti·ªÅn th·ª´a:</span>
            <span class="change-value">{{ formatVnd(changeAmount()) }}</span>
          </div>
        </div>
        }
      </div>
      }
    </div>

    <div class="modal-footer">
      <button class="cancel-btn" (click)="closePaymentModal()">H·ªßy</button>
      <button class="print-btn" (click)="printReceipt()" [disabled]="!canProcessPayment()">
        üñ®Ô∏è In h√≥a ƒë∆°n
      </button>
      <button class="confirm-btn" (click)="confirmPayment()" [disabled]="!canProcessPayment()">
        X√°c nh·∫≠n thanh to√°n
      </button>
    </div>
  </div>
</div>
}

<!-- Modal ch·ªçn kh√°ch h√†ng -->
@if (showCustomerModal()) {
<div class="modal-overlay" (click)="closeCustomerModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Ch·ªçn kh√°ch h√†ng</h2>
      <button class="close-btn" (click)="closeCustomerModal()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="search-box">
        <input
          type="text"
          placeholder="T√¨m ki·∫øm kh√°ch h√†ng..."
          [value]="customerSearchTerm()"
          (input)="onCustomerSearchInput($event)"
          class="search-input"
        />
        <span class="search-icon">üîç</span>
      </div>

      <div class="customer-list">
        @for (customer of filteredCustomers(); track customer.id) {
        <div class="customer-item" (click)="selectCustomer(customer)">
          <div class="customer-info">
            <div class="customer-name">{{ customer.name }}</div>
            <div class="customer-details">
              <span class="phone">{{ customer.phone }}</span>
              @if (customer.email) {
              <span class="email">{{ customer.email }}</span>
              }
            </div>
          </div>
          <div class="customer-stats">
            <div class="orders-count">{{ customer.totalOrders }} ƒë∆°n</div>
            <div class="total-spent">{{ formatVnd(customer.totalSpent) }}</div>
          </div>
        </div>
        } @if (filteredCustomers().length === 0) {
        <div class="empty-state">
          <div class="empty-icon">üë•</div>
          <p>Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng</p>
        </div>
        }

        <div class="add-customer-section">
          <button class="add-customer-btn" (click)="openAddCustomerModal()">
            <span class="btn-icon">‚ûï</span>
            Th√™m kh√°ch h√†ng m·ªõi
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
}

<!-- Modal th√™m kh√°ch h√†ng m·ªõi -->
@if (showAddCustomerModal()) {
<div class="modal-overlay" (click)="closeAddCustomerModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Th√™m kh√°ch h√†ng m·ªõi</h2>
      <button class="close-btn" (click)="closeAddCustomerModal()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label>T√™n kh√°ch h√†ng *</label>
        <input
          type="text"
          [value]="newCustomer().name"
          (input)="onNewCustomerFieldChange('name', $event)"
          placeholder="Nh·∫≠p t√™n kh√°ch h√†ng..."
          class="form-input"
        />
      </div>

      <div class="form-group">
        <label>S·ªë ƒëi·ªán tho·∫°i *</label>
        <input
          type="tel"
          [value]="newCustomer().phone"
          (input)="onNewCustomerFieldChange('phone', $event)"
          placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i..."
          class="form-input"
        />
      </div>

      <div class="form-group">
        <label>Email</label>
        <input
          type="email"
          [value]="newCustomer().email"
          (input)="onNewCustomerFieldChange('email', $event)"
          placeholder="Nh·∫≠p email..."
          class="form-input"
        />
      </div>

      <div class="form-group">
        <label>ƒê·ªãa ch·ªâ</label>
        <textarea
          [value]="newCustomer().address"
          (input)="onNewCustomerFieldChange('address', $event)"
          placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ..."
          class="form-textarea"
          rows="3"
        ></textarea>
      </div>

      <div class="form-group">
        <label>Ghi ch√∫</label>
        <textarea
          [value]="newCustomer().notes"
          (input)="onNewCustomerFieldChange('notes', $event)"
          placeholder="Nh·∫≠p ghi ch√∫..."
          class="form-textarea"
          rows="2"
        ></textarea>
      </div>
    </div>

    <div class="modal-footer">
      <button class="cancel-btn" (click)="closeAddCustomerModal()">H·ªßy</button>
      <button class="confirm-btn" (click)="addNewCustomer()">Th√™m kh√°ch h√†ng</button>
    </div>
  </div>
</div>
}
